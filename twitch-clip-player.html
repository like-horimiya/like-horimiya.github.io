<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Clip Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
        }
        
        #clip-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }
        
        #clip-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
            pointer-events: none; /* マウス操作を無効化してオーバーレイ再表示を防ぐ */
        }
        
        #clip-frame.active {
            display: block;
        }
        
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="clip-container">
        <iframe id="clip-frame" allowfullscreen allow="autoplay; encrypted-media"></iframe>
        <div id="status">待機中...</div>
    </div>

    <script type="module">
        import tmi from 'https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/+esm';

        // ========================================
        // 固定設定（CLIENT_IDのみ）
        // ========================================
        const CLIENT_ID = 'gp762nuuoqcoxypju8c569th9wz7q5';

        // ========================================
        // URLパラメータから設定を取得
        // ========================================
        const urlParams = new URLSearchParams(window.location.search);
        
        const CONFIG = {
            // 必須パラメータ
            CHANNEL_NAME: (urlParams.get('channel') || '').toLowerCase(),
            BROADCASTER_ID: urlParams.get('broadcaster_id') || '',
            ACCESS_TOKEN: urlParams.get('token') || '',
            
            // オプションパラメータ（デフォルト値あり）
            TRIGGER_COMMAND: urlParams.get('trigger') || '!clip',
            FEATURED_ONLY: urlParams.get('featured') === 'true',
            CLIP_PERIOD_DAYS: urlParams.get('days') ? parseInt(urlParams.get('days')) : null, // nullの場合は日付範囲指定なし
            DEBUG_MODE: urlParams.get('debug') === 'true'
        };

        // ========================================
        // グローバル変数
        // ========================================
        let clips = [];
        let shuffledClips = [];  // シャッフルされたクリップ配列
        let currentIndex = 0;     // 現在の再生位置
        let isPlaying = false;
        let clipEndTimer = null;

        const statusEl = document.getElementById('status');
        const clipFrame = document.getElementById('clip-frame');

        if (CONFIG.DEBUG_MODE) {
            statusEl.style.display = 'block';
        }

        // ========================================
        // ステータス更新
        // ========================================
        function updateStatus(message) {
            console.log(message);
            statusEl.textContent = message;
        }

        // ========================================
        // Twitch API: クリップ取得（全件取得）
        // ========================================
        async function fetchClips() {
            if (!CONFIG.ACCESS_TOKEN) {
                updateStatus('エラー: アクセストークンが指定されていません');
                console.error('URLパラメータで token= を指定してください');
                return;
            }

            try {
                updateStatus('クリップ取得中...');
                clips = [];
                let cursor = null;
                let totalFetched = 0;

                // ページネーションで全クリップを取得
                do {
                    const url = new URL('https://api.twitch.tv/helix/clips');
                    url.searchParams.append('broadcaster_id', CONFIG.BROADCASTER_ID);
                    url.searchParams.append('first', '100');

                    // CLIP_PERIOD_DAYSがnullでない場合のみ日付範囲を指定
                    if (CONFIG.CLIP_PERIOD_DAYS !== null) {
                        const endDate = new Date();
                        const startDate = new Date();
                        startDate.setDate(startDate.getDate() - CONFIG.CLIP_PERIOD_DAYS);

                        url.searchParams.append('started_at', startDate.toISOString());
                        url.searchParams.append('ended_at', endDate.toISOString());
                    }

                    if (CONFIG.FEATURED_ONLY) {
                        url.searchParams.append('is_featured', 'true');
                    }

                    // 2ページ目以降はカーソルを指定
                    if (cursor) {
                        url.searchParams.append('after', cursor);
                    }

                    const response = await fetch(url, {
                        headers: {
                            'Client-ID': CLIENT_ID,
                            'Authorization': `Bearer ${CONFIG.ACCESS_TOKEN}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // クリップを配列に追加
                    if (data.data && data.data.length > 0) {
                        clips.push(...data.data);
                        totalFetched += data.data.length;
                        
                        const periodText = CONFIG.CLIP_PERIOD_DAYS !== null 
                            ? `${CONFIG.CLIP_PERIOD_DAYS}日間` 
                            : '全期間';
                        updateStatus(`クリップ取得中: ${totalFetched}件 (${periodText})`);
                    }

                    // 次のページのカーソルを取得
                    cursor = data.pagination && data.pagination.cursor ? data.pagination.cursor : null;

                    // デバッグ用ログ
                    console.log(`ページ取得完了: ${data.data.length}件, 累計: ${totalFetched}件, 次のカーソル: ${cursor ? 'あり' : 'なし'}`);

                } while (cursor); // カーソルがある限り繰り返す

                const periodText = CONFIG.CLIP_PERIOD_DAYS !== null 
                    ? `${CONFIG.CLIP_PERIOD_DAYS}日間` 
                    : '全期間';
                updateStatus(`クリップ取得完了: ${clips.length}件 (${periodText})`);
                console.log('取得したクリップ:', clips);

                // クリップをシャッフル
                shuffleClips();

            } catch (error) {
                updateStatus(`エラー: ${error.message}`);
                console.error('クリップ取得エラー:', error);
            }
        }

        // ========================================
        // クリップをシャッフル
        // ========================================
        function shuffleClips() {
            if (clips.length === 0) {
                shuffledClips = [];
                currentIndex = 0;
                return;
            }

            // Fisher-Yates シャッフルアルゴリズム
            shuffledClips = [...clips]; // 配列をコピー
            for (let i = shuffledClips.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledClips[i], shuffledClips[j]] = [shuffledClips[j], shuffledClips[i]];
            }
            
            currentIndex = 0;
            console.log('クリップをシャッフルしました:', shuffledClips.length, '件');
        }

        // ========================================
        // 次のクリップを取得（シャッフル再生）
        // ========================================
        function getNextClip() {
            if (shuffledClips.length === 0) return null;

            // 全てのクリップを再生し終えたら、再度シャッフル
            if (currentIndex >= shuffledClips.length) {
                console.log('全クリップ再生完了。再シャッフルします。');
                shuffleClips();
            }

            const clip = shuffledClips[currentIndex];
            currentIndex++;
            
            console.log(`シャッフル再生: ${currentIndex}/${shuffledClips.length}件目`);
            return clip;
        }

        // ========================================
        // クリップIDを抽出
        // ========================================
        function getClipSlug(url) {
            const match = url.match(/clip\/([^?]+)/);
            return match ? match[1] : null;
        }

        // ========================================
        // クリップ再生
        // ========================================
        function playClip(clip) {
            if (!clip) {
                updateStatus('再生可能なクリップがありません');
                return;
            }

            stopCurrentClip();

            const clipSlug = getClipSlug(clip.url);
            if (!clipSlug) {
                console.error('クリップIDの抽出に失敗:', clip.url);
                return;
            }

            const hostname = window.location.hostname || 'localhost';
            const embedUrl = `https://clips.twitch.tv/embed?clip=${clipSlug}&parent=${hostname}&autoplay=true&muted=false&controls=false&allowfullscreen=false`;
            
            console.log('Embed URL:', embedUrl);
            console.log('Hostname:', hostname);
            
            clipFrame.src = embedUrl;
            clipFrame.classList.add('active');
            isPlaying = true;

            updateStatus(`再生中: ${clip.title} (${clip.duration}秒)`);
            console.log('再生クリップ:', clip);

            const duration = Math.ceil(clip.duration) + 2;
            clipEndTimer = setTimeout(() => {
                stopCurrentClip();
                updateStatus('待機中...');
            }, duration * 1000);
        }

        // ========================================
        // クリップ停止
        // ========================================
        function stopCurrentClip() {
            if (clipEndTimer) {
                clearTimeout(clipEndTimer);
                clipEndTimer = null;
            }

            clipFrame.classList.remove('active');
            clipFrame.src = '';
            isPlaying = false;
        }

        // ========================================
        // Twitch チャット接続
        // ========================================
        async function connectToChat() {
            if (!CONFIG.CHANNEL_NAME) {
                updateStatus('エラー: チャンネル名が指定されていません');
                console.error('URLパラメータで channel= を指定してください');
                return;
            }

            const client = new tmi.Client({
                channels: [CONFIG.CHANNEL_NAME]
            });

            client.connect().catch(console.error);

            client.on('message', (channel, tags, message, self) => {
                console.log(`${tags['display-name']}: ${message}`);
                
                if (message.trim() === CONFIG.TRIGGER_COMMAND) {
                    console.log(`トリガー検出: ${tags.username} が "${message}" を送信`);
                    
                    const nextClip = getNextClip();
                    if (nextClip) {
                        playClip(nextClip);
                    } else {
                        updateStatus('クリップが見つかりません');
                    }
                }
            });

            client.on('connected', () => {
                updateStatus('チャット接続完了');
                console.log('Twitch チャットに接続しました');
            });

            client.on('disconnected', () => {
                updateStatus('チャット切断');
                console.log('Twitch チャットから切断されました');
            });
        }

        // ========================================
        // 初期化
        // ========================================
        async function init() {
            updateStatus('初期化中...');
            
            // 必須パラメータチェック
            if (!CONFIG.CHANNEL_NAME) {
                updateStatus('エラー: channel パラメータが必要です');
                console.error('使用方法: ?channel=チャンネル名&broadcaster_id=ID&token=トークン');
                return;
            }
            
            if (!CONFIG.BROADCASTER_ID) {
                updateStatus('エラー: broadcaster_id パラメータが必要です');
                console.error('使用方法: ?channel=チャンネル名&broadcaster_id=ID&token=トークン');
                return;
            }
            
            if (!CONFIG.ACCESS_TOKEN) {
                updateStatus('エラー: token パラメータが必要です');
                console.error('使用方法: ?channel=チャンネル名&broadcaster_id=ID&token=トークン');
                return;
            }

            // クリップ取得
            await fetchClips();
            
            // チャット接続
            await connectToChat();
            
            updateStatus('待機中...');
        }

        // ページ読み込み時に初期化
        window.addEventListener('load', init);

        // 定期的にクリップリストを更新（10分ごと）
        setInterval(fetchClips, 10 * 60 * 1000);
    </script>
</body>
</html>